<!DOCTYPE html>
<html>
  <head>
    <title>IMSA Room Builder</title>
    <style>
      body {
          margin: 0px;
          padding: 0px;
          overflow-x: hidden;
          overflow-y: auto;
      }
      canvas {
          margin: 0px auto;
          padding: 0px;
      }
    </style>
  </head>
  <body>
    <p style="text-align: center;"><a href="./">Standard Room</a> | <a href="lroom/">L Room</a> | To use this, drag the furniture around with the mouse. Right click to rotate furniture. Flip the room vertically with the f key.</p>
    <p style="text-align: center; margin: 0px;"><canvas id="Builder" width="100%"></canvas></p>
    <script src="https://cdn.jsdelivr.net/processing.js/1.4.8/processing.min.js"></script>
    <script>
      document.getElementById("Builder").offsetWidth = window.innerHeight - 19.2;
      document.getElementById("Builder").offsetHeight = window.innerHeight - 19.2;
      var builder = function(pI_AppName) {
        with (pI_AppName) {
          size(window.innerHeight - 19.2, window.innerHeight - 19.2);
          frameRate(60);
/* @pjs preload="desk.jpg"; */

var desk;
desk = loadImage("desk.jpg");

var roomDimensions = { width: 175, height: 127 };

var InchesToPixels = function(inches) {
    return inches * width / roomDimensions.width;
};

var roomSize = { width: InchesToPixels(roomDimensions.width), height: InchesToPixels(roomDimensions.height) };
var gridSize = InchesToPixels(1);
var mouse = { x: mouseX, y: mouseY };

var RoomItem = function(data) {
    this.pos = data.pos || { x: data.x || 0, y: data.y || 0 };
    this.collider = data.collider || { width: data.width || width * 0.1, height: data.height || height * 0.1 };
    this.angle = data.angle || 0;
    this.selected = false;
    this.itemName = data.itemName || "Room\nItem";
    this.canBeSelected = data.canBeSelected || false;
};
RoomItem.prototype.MouseIn = function() {
    return mouseX >= this.pos.x && mouseX <= this.pos.x + this.collider.width && mouseY >= this.pos.y && mouseY <= this.pos.y + this.collider.height;
};
RoomItem.prototype.Display = function() {
    pushMatrix();
    translate(this.pos.x, this.pos.y);
    stroke(0);
    strokeWeight(0.1);
    rectMode(CORNER);
    fill(155);
    rect(0, 0, this.collider.width, this.collider.height);
    imageMode(CORNER);
    pushMatrix();
    rotate(radians(this.angle));
    img = null;
    if (this.itemName === "Desk 1" || this.itemName === "Desk 2") { img = desk; }
    image(img, 0, 0, this.angle === 0 ? this.collider.width : this.collider.height, this.angle === 0 ? this.collider.height : this.collider.width);
    popMatrix();
    fill(255);
    textAlign(CENTER, CENTER);
    textSize(min(this.collider.width, this.collider.height) / 5);
    text(this.itemName, this.collider.width / 2, this.collider.height / 2);
    popMatrix();
};
RoomItem.prototype.OnMousePress = function(canSelect, button) {
    if (button === LEFT && canSelect && !this.selected && this.canBeSelected && this.MouseIn()) {
        this.selected = true;
    }
    else if (button === RIGHT && this.MouseIn()) {
        this.SetRotation(90 - this.angle);
    }
};
RoomItem.prototype.OnMouseRelease = function() {
    this.selected = false;
};
RoomItem.prototype.OnMouseDrag = function() {
    if (this.selected) {
        this.pos.x += mouseX - mouse.x;
        this.pos.y += mouseY - mouse.y;
        this.Snap();
    }
};
RoomItem.prototype.OnMouseOut = function() {
    this.selected = false;
};
RoomItem.prototype.Snap = function() {
    this.pos.x = round(this.pos.x / gridSize) * gridSize;
    this.pos.y = round(this.pos.y / gridSize) * gridSize;
    this.pos.x = constrain(this.pos.x, 0, roomSize.width - this.collider.width);
    this.pos.y = constrain(this.pos.y, 0, roomSize.height - this.collider.height);
};
RoomItem.prototype.SetRotation = function(angle) {
    if (this.angle !== angle) {
        var w = this.collider.height;
        var h = this.collider.width;
        this.collider.width = w;
        this.collider.height = h;
    }
    
    this.angle = angle;
    
    this.Snap();
};
RoomItem.prototype.Run = function() {
    this.Display();
};

var selected = null;
var ptac = new RoomItem({ x: InchesToPixels(0), y: InchesToPixels(127 - 18), itemName: "PTAC", width: InchesToPixels(54), height: InchesToPixels(18), canBeSelected: false });
var bed1 = new RoomItem({ x: InchesToPixels(0), y: InchesToPixels(0), itemName: "Bed 1", width: InchesToPixels(81), height: InchesToPixels(37), canBeSelected: true });
var bed2 = new RoomItem({ x: InchesToPixels(0), y: InchesToPixels(0), itemName: "Bed 2", width: InchesToPixels(81), height: InchesToPixels(37), canBeSelected: true });
var closet1 = new RoomItem({ x: InchesToPixels(0), y: InchesToPixels(0), itemName: "Closet 1", width: InchesToPixels(36), height: InchesToPixels(24), canBeSelected: true });
var closet2 = new RoomItem({ x: InchesToPixels(0), y: InchesToPixels(0), itemName: "Closet 2", width: InchesToPixels(36), height: InchesToPixels(24), canBeSelected: true });
var desk1 = new RoomItem({ x: InchesToPixels(0), y: InchesToPixels(0), itemName: "Desk 1", width: InchesToPixels(45), height: InchesToPixels(22), canBeSelected: true });
var desk2 = new RoomItem({ x: InchesToPixels(0), y: InchesToPixels(0), itemName: "Desk 2", width: InchesToPixels(45), height: InchesToPixels(22), canBeSelected: true });
var items = [ ptac, bed1, bed2, closet1, closet2, desk1, desk2 ];

var flipped = false;

var FlipRoom = function() {
    flipped = !flipped;
    for (var i = 0; i < items.length; ++i) {
        items[i].pos.y = roomSize.height - items[i].pos.y - items[i].collider.height;
        items[i].Snap();
    }
};

var tooClose = "";

var FindTooClose = function(item) {
    var xClose = abs((item.pos.x + item.collider.width / 2) - (ptac.pos.x + ptac.collider.width / 2)) < InchesToPixels(12) + item.collider.width / 2 + ptac.collider.width / 2;
    var yClose = abs((item.pos.y + item.collider.height / 2) - (ptac.pos.y + ptac.collider.height / 2)) < InchesToPixels(12) + item.collider.height / 2 + ptac.collider.height / 2;
    if (xClose && yClose) {
        if (tooClose.length > 0) { tooClose += ", "; }
        tooClose += item.itemName;
    }
};

keyPressed = function() {
    if (key.toString() === "f") {
        FlipRoom();
    }
};

mousePressed = function() {
    tooClose = "";
    
    for (var i = items.length - 1; i >= 0; --i) {
        if (items[i].itemName !== "PTAC") {
            items[i].OnMousePress(!selected, mouseButton);
            FindTooClose(items[i]);
        }
        if (!selected) {
            if (items[i].selected) { selected = items[i]; }
        }
    }
};
mouseReleased = function() {
    for (var i = 0; i < items.length; ++i) {
        items[i].OnMouseRelease();
    }
    
    selected = null;
};
mouseDragged = function() {
    tooClose = "";
    
    for (var i = 0; i < items.length; ++i) {
        if (items[i].itemName !== "PTAC") {
            items[i].OnMouseDrag();
            FindTooClose(items[i]);
        }
    }
};
mouseOut = function() {
    for (var i = 0; i < items.length; ++i) {
        items[i].OnMouseOut();
    }
};

draw = function() {
    background(255);
    
    stroke(0);
    strokeWeight(0.1);
    
    for (var x = 0; x < roomSize.width + gridSize / 2; x += gridSize) {
        line(x, 0, x, roomSize.height);
    }
    for (var y = 0; y < roomSize.height + gridSize / 2; y += gridSize) {
        line(0, y, roomSize.width, y);
    }
    
    for (var i = 0; i < items.length; ++i) {
        items[i].Run();
    }
    
    stroke(255, 75, 75);
    strokeWeight(0.5);
    noFill();
    rectMode(CORNER);
    rect(ptac.pos.x - InchesToPixels(12), ptac.pos.y - InchesToPixels(12), ptac.collider.width + InchesToPixels(24), ptac.collider.height + InchesToPixels(24));
    textAlign(RIGHT, CENTER);
    textSize(InchesToPixels(4));
    fill(0);
    if (!flipped) {
        text("Room Door", roomSize.width * 0.95, InchesToPixels(51 / 2));
        text("Bathroom Door", roomSize.width * 0.95, InchesToPixels(51 + 76 / 2));
    }
    else {
        text("Room Door", roomSize.width * 0.95, roomSize.height - InchesToPixels(51 / 2));
        text("Bathroom Door", roomSize.width * 0.95, roomSize.height - InchesToPixels(51 + 76 / 2));
    }
    
    if (tooClose !== "") {
        textAlign(CENTER, CENTER);
        textSize(roomSize.width / 20);
        fill(255, 75, 75);
        text(tooClose + " too close to PTAC", width / 2, roomSize.height * 1.25);
    }
    
    mouse.x = mouseX;
    mouse.y = mouseY;
};
        }
      };
      
      var c_Builder = document.getElementById("Builder");
      
      var pI_Builder = new Processing(c_Builder, builder);
    </script>
  </body>
</html>
